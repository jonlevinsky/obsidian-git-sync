<!DOCTYPE html>
<html lang="cs" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevinskyJ - Obsidian</title>
    <link rel="stylesheet" href="styles.css">
    <style>:root { --primary: #7c3aed; }</style>
</head>
<body class="login-page">
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="login-container glass-panel">
        <div class="logo-wrap">
            <div class="logo-glow"></div>
            <div class="logo">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                    <path d="M24 4L6 14v20l18 10 18-10V14L24 4z" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>
                    <path d="M24 8L10 16v16l14 8 14-8V16L24 8z" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.6"/>
                    <path d="M24 12L14 18v12l10 6 10-6V18L24 12z" fill="currentColor" opacity="0.15"/>
                    <circle cx="24" cy="24" r="4" fill="currentColor" opacity="0.8"/>
                </svg>
            </div>
        </div>
        <h1>LevinskyJ - Obsidian</h1>
        <p class="subtitle">Enter password to unlock vault</p>
        
        <form id="loginForm" class="login-form">
            <div class="input-group">
                <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <input type="password" id="password" placeholder="Password" autocomplete="off" autofocus>
                <button type="button" class="toggle-password" onclick="togglePassword()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>
            <button type="submit" id="submitBtn" class="btn-primary">
                <span class="btn-text">Unlock</span>
                <span class="btn-loader hidden"></span>
                <svg class="btn-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </form>
        
        <div id="progress" class="progress-container hidden">
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <span class="progress-text">Loading...</span>
        </div>
        
        <div id="error" class="error-message hidden"></div>
    </div>

    <script>
        const isMultiChunk = true;
        
        function togglePassword() {
            const input = document.getElementById('password');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('submitBtn');
            const error = document.getElementById('error');
            const progress = document.getElementById('progress');
            
            btn.disabled = true;
            btn.querySelector('.btn-text').classList.add('hidden');
            btn.querySelector('.btn-loader').classList.remove('hidden');
            error.classList.add('hidden');
            progress.classList.remove('hidden');
            
            try {
                let encryptedData = '';
                
                if (isMultiChunk) {
                    const manifest = await fetch('vault-manifest.json').then(r => r.json());
                    for (let i = 0; i < manifest.chunks; i++) {
                        const chunk = await fetch(`vault-data-${i}.enc`).then(r => r.text());
                        encryptedData += chunk;
                        updateProgress((i + 1) / manifest.chunks * 40);
                    }
                } else {
                    encryptedData = await fetch('vault-data.enc').then(r => r.text());
                    updateProgress(40);
                }
                
                const decrypted = await decryptData(encryptedData, password, (p) => {
                    updateProgress(40 + p * 60);
                });
                
                sessionStorage.setItem('vaultData', JSON.stringify(decrypted));
                sessionStorage.setItem('vaultUnlocked', 'true');
                window.location.href = 'app.html';
                
            } catch (err) {
                console.error(err);
                error.textContent = 'Špatné heslo nebo poškozená data';
                error.classList.remove('hidden');
                btn.disabled = false;
                btn.querySelector('.btn-text').classList.remove('hidden');
                btn.querySelector('.btn-loader').classList.add('hidden');
                progress.classList.add('hidden');
            }
        });
        
        function updateProgress(pct) {
            document.querySelector('.progress-fill').style.width = pct + '%';
            document.querySelector('.progress-text').textContent = Math.round(pct) + '%';
        }
        
        async function decryptData(encryptedBase64, password, onProgress) {
            const combined = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
            const metaLength = new DataView(combined.buffer).getUint32(0, false);
            const metadata = JSON.parse(new TextDecoder().decode(combined.slice(4, 4 + metaLength)));
            
            const salt = new Uint8Array(metadata.salt);
            const iv = new Uint8Array(metadata.iv);
            const key = await deriveKey(password, salt);
            
            let offset = 4 + metaLength;
            const chunks = [];
            const chunkSize = 64 * 1024 + 16;
            
            for (let i = 0; i < metadata.chunks; i++) {
                const chunkIv = new Uint8Array(iv);
                new DataView(chunkIv.buffer).setUint32(8, i, false);
                
                const encryptedChunk = combined.slice(offset, offset + chunkSize);
                offset += chunkSize;
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: chunkIv }, key, encryptedChunk
                );
                chunks.push(new Uint8Array(decrypted));
                if (onProgress) onProgress((i + 1) / metadata.chunks);
            }
            
            const totalLength = chunks.reduce((a, b) => a + b.length, 0);
            const result = new Uint8Array(totalLength);
            let pos = 0;
            chunks.forEach(c => { result.set(c, pos); pos += c.length; });
            
            return JSON.parse(new TextDecoder().decode(result));
        }
        
        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
            );
        }
    </script>
</body>
</html>