<!DOCTYPE html>
<html lang="cs" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negr</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>:root { --primary: #7c3aed; }</style>
</head>
<body>
    <div id="app">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="site-title">
                    <span class="logo">‚óà</span>
                    <span>Negr</span>
                </div>
                <button class="menu-toggle" onclick="toggleSidebar()">‚úï</button>
            </div>
            
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Hledat (Ctrl+K)..." autocomplete="off">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
                <button onclick="toggleSort()" class="btn-icon" title="≈òazen√≠">‚áÖ</button>
            </div>
            
            <div id="sortInfo" class="sort-info hidden">
                <span id="sortLabel">Se≈ôazeno: A-Z</span>
            </div>
            
            <nav id="fileTree" class="file-tree"></nav>
            
            <div class="sidebar-footer">
                <button onclick="logout()" class="btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Odhl√°sit
                </button>
            </div>
        </aside>
        
        <div class="mobile-header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <span class="mobile-title">Negr</span>
            <button onclick="toggleSort()" class="btn-icon" title="≈òazen√≠">‚áÖ</button>
        </div>
        
        <main class="content">
            <div class="content-header">
                <nav id="breadcrumbs" class="breadcrumbs"></nav>
                <div class="actions">
                    <button onclick="toggleTheme()" class="btn-icon" title="T√©ma">‚óê</button>
                </div>
            </div>
            
            <article id="pageContent" class="markdown-body">
                <div class="welcome">
                    <div class="welcome-icon">‚óà</div>
                    <h1>Negr</h1>
                    <p>Vyber pozn√°mku v menu nebo pou≈æij vyhled√°v√°n√≠</p>
                    <div class="stats" id="stats"></div>
                </div>
            </article>
        </main>
    </div>
    
    <div id="imageModal" class="modal hidden" onclick="closeModal()">
        <img id="modalImage" src="" alt="">
    </div>

    <script>
        if (!sessionStorage.getItem('vaultUnlocked')) {
            window.location.href = 'index.html';
        }
        
        const vaultData = JSON.parse(sessionStorage.getItem('vaultData'));
        const index = vaultData.index || {};
        let currentPath = '';
        let currentSort = vaultData.meta?.sortBy || 'name';
        let sortFoldersFirst = vaultData.meta?.sortFoldersFirst !== false;
        
        const totalFiles = Object.keys(vaultData.files).length;
        const mdFiles = Object.values(vaultData.files).filter(f => f.type === 'markdown').length;
        const imgFiles = Object.values(vaultData.files).filter(f => f.type === 'image').length;
        document.getElementById('stats').innerHTML = `
            <span>${mdFiles} pozn√°mek</span> ‚Ä¢ <span>${imgFiles} obr√°zk≈Ø</span>
        `;
        
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });
        
        const renderer = new marked.Renderer();
        const originalLink = renderer.link.bind(renderer);
        
        renderer.link = function(href, title, text) {
            if (!href.startsWith('http') && !href.startsWith('#')) {
                return renderWikiLink(href, text, false);
            }
            return originalLink(href, title, text);
        };
        
        renderer.image = function(href, title, text) {
            const resolved = resolvePath(href);
            const file = vaultData.files[resolved];
            if (file && file.type === 'image') {
                return `<img src="data:${file.mime};base64,${file.data}" 
                    alt="${text}" title="${title || ''}" 
                    class="embed-image" onclick="openModal(this)" 
                    data-path="${resolved}">`;
            }
            return `<span class="broken-image">‚ùå Obr√°zek: ${href}</span>`;
        };
        
        marked.use({ renderer });
        
        document.addEventListener('DOMContentLoaded', () => {
            renderFileTree(vaultData.structure, document.getElementById('fileTree'));
            setupSearch();
            updateSortLabel();
            window.addEventListener('hashchange', handleRoute);
            handleRoute();
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });
        
        function resolvePath(link, currentFile = currentPath) {
            link = link.replace(/\.md$/i, '');
            const lower = link.toLowerCase();
            if (index[lower]) return index[lower];
            const slug = slugify(link);
            if (index[slug]) return index[slug];
            
            if (currentFile) {
                const currentDir = currentFile.substring(0, currentFile.lastIndexOf('/'));
                const relativePath = currentDir ? `${currentDir}/${link}` : link;
                if (vaultData.files[relativePath]) return relativePath;
                if (vaultData.files[relativePath + '.md']) return relativePath + '.md';
            }
            
            if (vaultData.files[link + '.md']) return link + '.md';
            return link;
        }
        
        function renderWikiLink(target, alias, isEmbed) {
            const resolved = resolvePath(target);
            const file = vaultData.files[resolved];
            const displayText = alias || target.split('/').pop().replace(/\.md$/i, '');
            
            if (isEmbed) {
                if (!file) return `<div class="embed-error">‚ùå Nenalezeno: ${target}</div>`;
                
                if (file.type === 'image') {
                    return `<img src="data:${file.mime};base64,${file.data}" 
                        alt="${displayText}" class="embed-image" 
                        onclick="openModal(this)" data-path="${resolved}">`;
                } else if (file.type === 'markdown') {
                    let preview = file.content.substring(0, 500);
                    if (file.content.length > 500) preview += '...';
                    return `<div class="embed-note">
                        <div class="embed-header">‚ñ¶ ${displayText}</div>
                        <div class="embed-content">${marked.parse(preview)}</div>
                        <a href="#/note/${encodeURIComponent(resolved)}" class="embed-link">Otev≈ô√≠t ‚Üí</a>
                    </div>`;
                }
                return `<div class="embed-file">üìé ${displayText}</div>`;
            }
            
            const isBroken = !file;
            return `<a href="#/note/${encodeURIComponent(resolved)}" 
                class="internal-link ${isBroken ? 'broken' : ''}" 
                data-path="${resolved}">${displayText}${isBroken ? ' ‚ö†' : ''}</a>`;
        }
        
        function processContent(content, filePath) {
            let processed = content;
            processed = processed.replace(/!\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (match, target, alias) => {
                return renderWikiLink(target, alias, true);
            });
            processed = processed.replace(/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (match, target, alias) => {
                return renderWikiLink(target, alias, false);
            });
            return processed;
        }
        
        function toggleSort() {
            const modes = [
                { by: 'name', foldersFirst: true, label: 'A-Z (slo≈æky prvn√≠)' },
                { by: 'name', foldersFirst: false, label: 'A-Z (v≈°e)' },
                { by: 'date', foldersFirst: true, label: 'Nejnovƒõj≈°√≠ (slo≈æky prvn√≠)' },
                { by: 'date', foldersFirst: false, label: 'Nejnovƒõj≈°√≠ (v≈°e)' }
            ];
            
            const currentIndex = modes.findIndex(m => m.by === currentSort && m.foldersFirst === sortFoldersFirst);
            const next = modes[(currentIndex + 1) % modes.length];
            
            currentSort = next.by;
            sortFoldersFirst = next.foldersFirst;
            
            renderFileTree(vaultData.structure, document.getElementById('fileTree'));
            updateSortLabel();
            
            localStorage.setItem('vaultSort', JSON.stringify({ by: currentSort, foldersFirst: sortFoldersFirst }));
        }
        
        function updateSortLabel() {
            const labels = {
                'name-true': 'A-Z ‚Üì',
                'name-false': 'A-Z',
                'date-true': 'Datum ‚Üì',
                'date-false': 'Datum'
            };
            const key = `${currentSort}-${sortFoldersFirst}`;
            const label = labels[key] || 'A-Z';
            document.getElementById('sortLabel').textContent = `Se≈ôazeno: ${label}`;
            document.getElementById('sortInfo').classList.remove('hidden');
        }
        
        function sortItems(items) {
            const folders = items.filter(i => i.type === 'folder');
            const files = items.filter(i => i.type === 'file');
            
            const sortFn = (a, b) => {
                if (currentSort === 'date') {
                    return (b.modified || 0) - (a.modified || 0);
                }
                return a.name.localeCompare(b.name, undefined, { sensitivity: 'base', numeric: true });
            };
            
            if (sortFoldersFirst) {
                return [...folders.sort(sortFn), ...files.sort(sortFn)];
            }
            return [...folders, ...files].sort(sortFn);
        }
        
        function renderFileTree(items, container, level = 0) {
            const sorted = sortItems(items);
            
            const ul = document.createElement('ul');
            ul.style.paddingLeft = level > 0 ? '8px' : '0';
            
            sorted.forEach(item => {
                const li = document.createElement('li');
                li.className = item.type;
                
                if (item.type === 'folder') {
                    const hasVisibleChildren = item.children && item.children.length > 0;
                    if (!hasVisibleChildren) return;
                    
                    const header = document.createElement('div');
                    header.className = 'folder-header';
                    header.innerHTML = `
                        <span class="chevron">‚ñ∂</span>
                        <span class="icon">üìÅ</span>
                        <span class="name">${item.name}</span>
                        <span class="count">${item.children.length}</span>
                    `;
                    header.onclick = () => toggleFolder(li);
                    li.appendChild(header);
                    
                    const children = document.createElement('div');
                    children.className = 'folder-children collapsed';
                    renderFileTree(item.children, children, level + 1);
                    li.appendChild(children);
                } else {
                    const icon = getFileIcon(item.extension);
                    li.innerHTML = `<a href="#/note/${encodeURIComponent(item.path)}" 
                        onclick="loadFile('${item.path}'); return false;"
                        class="file-link" data-path="${item.path}">
                        <span class="icon">${icon}</span>
                        <span class="name">${item.name.replace(/\.md$/i, '')}</span>
                    </a>`;
                }
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }
        
        function getFileIcon(ext) {
            const map = {
                'md': '‚ñ¶', 'png': 'üñº', 'jpg': 'üñº', 'jpeg': 'üñº', 'gif': 'üñº', 
                'svg': 'üé®', 'webp': 'üñº', 'bmp': 'üñº', 'ico': 'üéØ'
            };
            return map[ext] || 'üìÑ';
        }
        
        function toggleFolder(li) {
            li.classList.toggle('expanded');
            const children = li.querySelector('.folder-children');
            const chevron = li.querySelector('.chevron');
            if (children) children.classList.toggle('collapsed');
            if (chevron) chevron.textContent = li.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }
        
        function loadFile(path) {
            currentPath = path;
            const file = vaultData.files[path];
            const contentDiv = document.getElementById('pageContent');
            
            if (!file) {
                contentDiv.innerHTML = `<div class="error-page">
                    <h1>‚ö†</h1>
                    <p>Soubor nenalezen: ${path}</p>
                </div>`;
                return;
            }
            
            const parts = path.split('/');
            document.getElementById('breadcrumbs').innerHTML = parts.map((part, i) => {
                const partPath = parts.slice(0, i + 1).join('/');
                const isLast = i === parts.length - 1;
                const name = isLast ? part.replace(/\.md$/i, '') : part;
                return isLast ? `<span class="current">${name}</span>` 
                    : `<a href="#/note/${encodeURIComponent(partPath)}">${name}</a>`;
            }).join(' <span class="sep">/</span> ');
            
            if (file.type === 'markdown') {
                currentContent = file.content;
                const processed = processContent(file.content, path);
                contentDiv.innerHTML = marked.parse(processed);
                
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                contentDiv.querySelectorAll('.internal-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = link.getAttribute('data-path');
                        if (target) window.location.hash = '#/note/' + encodeURIComponent(target);
                    });
                });
                
            } else if (file.type === 'image') {
                contentDiv.innerHTML = `<div class="image-view">
                    <img src="data:${file.mime};base64,${file.data}" 
                        onclick="openModal(this)" class="full-image" alt="${path}">
                </div>`;
            }
            
            document.querySelectorAll('.file-link').forEach(a => a.classList.remove('active'));
            document.querySelector(`.file-link[data-path="${CSS.escape(path)}"]`)?.classList.add('active');
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
            window.scrollTo(0, 0);
        }
        
        function handleRoute() {
            const hash = window.location.hash;
            if (hash.startsWith('#/note/')) {
                loadFile(decodeURIComponent(hash.slice(7)));
            }
        }
        
        function setupSearch() {
            const search = document.getElementById('search');
            let debounce;
            
            search.addEventListener('input', (e) => {
                clearTimeout(debounce);
                debounce = setTimeout(() => performSearch(e.target.value), 300);
            });
            
            search.addEventListener('focus', () => {
                if (search.value) performSearch(search.value);
            });
        }
        
        function performSearch(query) {
            if (!query) {
                renderFileTree(vaultData.structure, document.getElementById('fileTree'));
                return;
            }
            
            const results = [];
            const q = query.toLowerCase();
            
            Object.entries(vaultData.files).forEach(([path, file]) => {
                if (file.type !== 'markdown') return;
                
                const name = path.split('/').pop().replace(/\.md$/i, '').toLowerCase();
                const content = file.content.toLowerCase();
                const folder = path.substring(0, path.lastIndexOf('/')).toLowerCase();
                
                let score = 0;
                if (name === q) score = 100;
                else if (name.startsWith(q)) score = 80;
                else if (name.includes(q)) score = 60;
                else if (content.includes(q)) score = 40;
                else if (folder.includes(q)) score = 20;
                
                if (score > 0) {
                    results.push({ path, file, score, name: path.split('/').pop().replace(/\.md$/i, '') });
                }
            });
            
            results.sort((a, b) => b.score - a.score);
            
            const container = document.getElementById('fileTree');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">üîç ≈Ω√°dn√© v√Ωsledky</div>';
                return;
            }
            
            const ul = document.createElement('ul');
            results.slice(0, 50).forEach(({ path, name }) => {
                const folder = path.substring(0, path.lastIndexOf('/')) || 'Root';
                const li = document.createElement('li');
                li.className = 'file';
                li.innerHTML = `<a href="#/note/${encodeURIComponent(path)}" 
                    onclick="loadFile('${path}'); return false;" class="file-link">
                    <span class="icon">‚ñ¶</span>
                    <div class="search-result">
                        <div class="name">${name}</div>
                        <div class="path">${folder}</div>
                    </div>
                </a>`;
                ul.appendChild(li);
            });
            container.appendChild(ul);
            
            const info = document.createElement('div');
            info.className = 'search-info';
            info.innerHTML = `<span>${results.length} v√Ωsledk≈Ø</span>`;
            container.insertBefore(info, ul);
        }
        
        function openModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = img.src;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }
        
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
        
        function slugify(text) {
            return text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('search').focus();
            }
        });
    </script>
</body>
</html>