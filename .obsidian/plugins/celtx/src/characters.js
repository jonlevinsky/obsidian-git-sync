import { __awaiter } from "tslib";
import { Modal, Notice, MarkdownView } from 'obsidian';
import * as path from 'path';
export class CharacterManager {
    constructor(app, plugin) {
        this.app = app;
        this.plugin = plugin;
    }
    openCharacterList() {
        new CharacterListModal(this.app, this.plugin).open();
    }
    getCharacterFiles(folderPath) {
        return __awaiter(this, void 0, void 0, function* () {
            const characterFolder = this.plugin.settings.defaultCharacterFolder;
            return this.app.vault.getFiles().filter((file) => file.path.startsWith(path.join(folderPath, characterFolder)));
        });
    }
    createNewCharacter(character, folderPath) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.plugin.settings.autoCreateFolders) {
                const characterFolderPath = path.join(folderPath, this.plugin.settings.defaultCharacterFolder);
                try {
                    const folderExists = yield this.app.vault.adapter.exists(characterFolderPath);
                    if (!folderExists) {
                        yield this.app.vault.createFolder(characterFolderPath);
                    }
                }
                catch (error) {
                    console.error("Error creating folder:", error);
                    throw error;
                }
            }
            const characterFilePath = path.join(folderPath, this.plugin.settings.defaultCharacterFolder, `${character}.md`);
            const file = yield this.app.vault.create(characterFilePath, `# ${character}`);
            return file;
        });
    }
}
class CharacterListModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        this.editor = null;
        this.characterNames = [];
        this.folderPath = '';
        const activeLeaf = this.app.workspace.activeLeaf;
        if (activeLeaf && activeLeaf.view instanceof MarkdownView) {
            this.editor = activeLeaf.view.editor;
        }
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: 'SELECT OR CREATE CHARACTER' });
        const newCharacterButton = contentEl.createEl('button', { text: '+ ADD NEW CHARACTER' });
        newCharacterButton.onclick = () => this.openNewCharacterModal();
        const characterListContainer = contentEl.createEl('div', {
            cls: 'character-list-container'
        });
        this.loadCharacters(characterListContainer);
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
    loadCharacters(characterListContainer) {
        return __awaiter(this, void 0, void 0, function* () {
            const activeFile = this.app.workspace.getActiveFile();
            if (!activeFile) {
                new Notice("NO FILE FOUND FOR THE CURRENT EDITOR.");
                return;
            }
            this.folderPath = path.dirname(activeFile.path);
            let characterFiles = yield this.plugin.characterManager.getCharacterFiles(this.folderPath);
            characterFiles = characterFiles.filter((file) => file.path !== activeFile.path);
            if (characterFiles.length > 0) {
                this.characterNames = characterFiles.map((file) => path.basename(file.path, '.md'));
                this.characterNames.forEach(character => {
                    const characterItem = characterListContainer.createEl('button', { text: character });
                    characterItem.onclick = () => __awaiter(this, void 0, void 0, function* () {
                        yield this.insertCharacterText(character);
                    });
                });
            }
            else {
                characterListContainer.createEl('p', { text: 'NO CHARACTERS AVAILABLE. CREATE ONE!' });
            }
        });
    }
    insertCharacterText(character) {
        return __awaiter(this, void 0, void 0, function* () {
            const formattedCharacterText = `[[${character}]]`;
            const text = `### ${formattedCharacterText}\n`;
            if (this.editor) {
                this.editor.replaceRange(text, this.editor.getCursor());
            }
            this.close();
        });
    }
    openNewCharacterModal() {
        return __awaiter(this, void 0, void 0, function* () {
            new NewCharacterModal(this.app, this.plugin, this.folderPath).open();
        });
    }
}
class NewCharacterModal extends Modal {
    constructor(app, plugin, folderPath) {
        super(app);
        this.plugin = plugin;
        this.folderPath = folderPath;
        this.characterInput = null;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: 'CREATE NEW CHARACTER' });
        this.characterInput = contentEl.createEl('input', { type: 'text', placeholder: 'Enter character name...' });
        const createButton = contentEl.createEl('button', { text: 'Create Character' });
        createButton.onclick = () => __awaiter(this, void 0, void 0, function* () {
            if (this.characterInput) {
                const characterName = this.characterInput.value.trim();
                if (characterName) {
                    yield this.plugin.characterManager.createNewCharacter(characterName, this.folderPath);
                    this.close();
                    new Notice(`Character ${characterName} created successfully!`);
                }
            }
        });
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhcmFjdGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL29ic2lkaWFuIHBsdWdpbi9jZWx0eC9zcmMvY2hhcmFjdGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFPLEtBQUssRUFBRSxNQUFNLEVBQWlCLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUzRSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUU3QixNQUFNLE9BQU8sZ0JBQWdCO0lBQ3pCLFlBQW9CLEdBQVEsRUFBVSxNQUEyQjtRQUE3QyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBcUI7SUFBRyxDQUFDO0lBRXJFLGlCQUFpQjtRQUNiLElBQUksa0JBQWtCLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekQsQ0FBQztJQUVLLGlCQUFpQixDQUFDLFVBQWtCOztZQUN0QyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxzQkFBc0IsQ0FBQztZQUNwRSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNILENBQUM7S0FBQTtJQUVLLGtCQUFrQixDQUFDLFNBQWlCLEVBQUUsVUFBa0I7O1lBQzFELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztnQkFDekMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMs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QUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDdkQsSUFBSSxhQUFhLEVBQUUsQ0FBQztvQkFDaEIsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ3RGLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDYixJQUFJLE1BQU0sQ0FBQyxhQUFhLGFBQWEsd0JBQXdCLENBQUMsQ0FBQztnQkFDbkUsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUEsQ0FBQztJQUNOLENBQUM7SUFFRCxPQUFPO1FBQ0gsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUMzQixTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBNb2RhbCwgTm90aWNlLCBURmlsZSwgRWRpdG9yLCBNYXJrZG93blZpZXcgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCBTY3JpcHRXcml0aW5nUGx1Z2luIGZyb20gJy4vbWFpbic7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2hhcmFjdGVyTWFuYWdlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwLCBwcml2YXRlIHBsdWdpbjogU2NyaXB0V3JpdGluZ1BsdWdpbikge31cclxuXHJcbiAgICBvcGVuQ2hhcmFjdGVyTGlzdCgpIHtcclxuICAgICAgICBuZXcgQ2hhcmFjdGVyTGlzdE1vZGFsKHRoaXMuYXBwLCB0aGlzLnBsdWdpbikub3BlbigpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGdldENoYXJhY3RlckZpbGVzKGZvbGRlclBhdGg6IHN0cmluZyk6IFByb21pc2U8VEZpbGVbXT4ge1xyXG4gICAgICAgIGNvbnN0IGNoYXJhY3RlckZvbGRlciA9IHRoaXMucGx1Z2luLnNldHRpbmdzLmRlZmF1bHRDaGFyYWN0ZXJGb2xkZXI7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLnZhdWx0LmdldEZpbGVzKCkuZmlsdGVyKChmaWxlOiBURmlsZSkgPT4gZmlsZS5wYXRoLnN0YXJ0c1dpdGgocGF0aC5qb2luKGZvbGRlclBhdGgsIGNoYXJhY3RlckZvbGRlcikpKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBjcmVhdGVOZXdDaGFyYWN0ZXIoY2hhcmFjdGVyOiBzdHJpbmcsIGZvbGRlclBhdGg6IHN0cmluZyk6IFByb21pc2U8VEZpbGU+IHtcclxuICAgICAgICBpZiAodGhpcy5wbHVnaW4uc2V0dGluZ3MuYXV0b0NyZWF0ZUZvbGRlcnMpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhcmFjdGVyRm9sZGVyUGF0aCA9IHBhdGguam9pbihmb2xkZXJQYXRoLCB0aGlzLnBsdWdpbi5zZXR0aW5ncy5kZWZhdWx0Q2hhcmFjdGVyRm9sZGVyKTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvbGRlckV4aXN0cyA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmFkYXB0ZXIuZXhpc3RzKGNoYXJhY3RlckZvbGRlclBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFmb2xkZXJFeGlzdHMpIHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGVGb2xkZXIoY2hhcmFjdGVyRm9sZGVyUGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgY3JlYXRpbmcgZm9sZGVyOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY2hhcmFjdGVyRmlsZVBhdGggPSBwYXRoLmpvaW4oZm9sZGVyUGF0aCwgdGhpcy5wbHVnaW4uc2V0dGluZ3MuZGVmYXVsdENoYXJhY3RlckZvbGRlciwgYCR7Y2hhcmFjdGVyfS5tZGApO1xyXG4gICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGUoY2hhcmFjdGVyRmlsZVBhdGgsIGAjICR7Y2hhcmFjdGVyfWApO1xyXG4gICAgICAgIHJldHVybiBmaWxlO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBDaGFyYWN0ZXJMaXN0TW9kYWwgZXh0ZW5kcyBNb2RhbCB7XHJcbiAgICBwcml2YXRlIGVkaXRvcjogRWRpdG9yIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIGNoYXJhY3Rlck5hbWVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBmb2xkZXJQYXRoOiBzdHJpbmcgPSAnJztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcHJpdmF0ZSBwbHVnaW46IFNjcmlwdFdyaXRpbmdQbHVnaW4pIHtcclxuICAgICAgICBzdXBlcihhcHApO1xyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUxlYWYgPSB0aGlzLmFwcC53b3Jrc3BhY2UuYWN0aXZlTGVhZjtcclxuICAgICAgICBpZiAoYWN0aXZlTGVhZiAmJiBhY3RpdmVMZWFmLnZpZXcgaW5zdGFuY2VvZiBNYXJrZG93blZpZXcpIHtcclxuICAgICAgICAgICAgdGhpcy5lZGl0b3IgPSBhY3RpdmVMZWFmLnZpZXcuZWRpdG9yO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvbk9wZW4oKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcbiAgICAgICAgY29udGVudEVsLmNyZWF0ZUVsKCdoMicsIHsgdGV4dDogJ1NFTEVDVCBPUiBDUkVBVEUgQ0hBUkFDVEVSJyB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgbmV3Q2hhcmFjdGVyQnV0dG9uID0gY29udGVudEVsLmNyZWF0ZUVsKCdidXR0b24nLCB7IHRleHQ6ICcrIEFERCBORVcgQ0hBUkFDVEVSJyB9KTtcclxuICAgICAgICBuZXdDaGFyYWN0ZXJCdXR0b24ub25jbGljayA9ICgpID0+IHRoaXMub3Blbk5ld0NoYXJhY3Rlck1vZGFsKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNoYXJhY3Rlckxpc3RDb250YWluZXIgPSBjb250ZW50RWwuY3JlYXRlRWwoJ2RpdicsIHtcclxuICAgICAgICAgICAgY2xzOiAnY2hhcmFjdGVyLWxpc3QtY29udGFpbmVyJ1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmxvYWRDaGFyYWN0ZXJzKGNoYXJhY3Rlckxpc3RDb250YWluZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQ2xvc2UoKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcbiAgICAgICAgY29udGVudEVsLmVtcHR5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBsb2FkQ2hhcmFjdGVycyhjaGFyYWN0ZXJMaXN0Q29udGFpbmVyOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUZpbGUgPSB0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlRmlsZSgpO1xyXG4gICAgICAgIGlmICghYWN0aXZlRmlsZSkge1xyXG4gICAgICAgICAgICBuZXcgTm90aWNlKFwiTk8gRklMRSBGT1VORCBGT1IgVEhFIENVUlJFTlQgRURJVE9SLlwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5mb2xkZXJQYXRoID0gcGF0aC5kaXJuYW1lKGFjdGl2ZUZpbGUucGF0aCk7XHJcblxyXG4gICAgICAgIGxldCBjaGFyYWN0ZXJGaWxlcyA9IGF3YWl0IHRoaXMucGx1Z2luLmNoYXJhY3Rlck1hbmFnZXIuZ2V0Q2hhcmFjdGVyRmlsZXModGhpcy5mb2xkZXJQYXRoKTtcclxuICAgICAgICBjaGFyYWN0ZXJGaWxlcyA9IGNoYXJhY3RlckZpbGVzLmZpbHRlcigoZmlsZTogVEZpbGUpID0+IGZpbGUucGF0aCAhPT0gYWN0aXZlRmlsZS5wYXRoKTtcclxuXHJcbiAgICAgICAgaWYgKGNoYXJhY3RlckZpbGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5jaGFyYWN0ZXJOYW1lcyA9IGNoYXJhY3RlckZpbGVzLm1hcCgoZmlsZTogVEZpbGUpID0+IHBhdGguYmFzZW5hbWUoZmlsZS5wYXRoLCAnLm1kJykpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jaGFyYWN0ZXJOYW1lcy5mb3JFYWNoKGNoYXJhY3RlciA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJJdGVtID0gY2hhcmFjdGVyTGlzdENvbnRhaW5lci5jcmVhdGVFbCgnYnV0dG9uJywgeyB0ZXh0OiBjaGFyYWN0ZXIgfSk7XHJcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJJdGVtLm9uY2xpY2sgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5pbnNlcnRDaGFyYWN0ZXJUZXh0KGNoYXJhY3Rlcik7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjaGFyYWN0ZXJMaXN0Q29udGFpbmVyLmNyZWF0ZUVsKCdwJywgeyB0ZXh0OiAnTk8gQ0hBUkFDVEVSUyBBVkFJTEFCTEUuIENSRUFURSBPTkUhJyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBpbnNlcnRDaGFyYWN0ZXJUZXh0KGNoYXJhY3Rlcjogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkQ2hhcmFjdGVyVGV4dCA9IGBbWyR7Y2hhcmFjdGVyfV1dYDtcclxuICAgICAgICBjb25zdCB0ZXh0ID0gYCMjIyAke2Zvcm1hdHRlZENoYXJhY3RlclRleHR9XFxuYDtcclxuICAgICAgICBpZiAodGhpcy5lZGl0b3IpIHtcclxuICAgICAgICAgICAgdGhpcy5lZGl0b3IucmVwbGFjZVJhbmdlKHRleHQsIHRoaXMuZWRpdG9yLmdldEN1cnNvcigpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgb3Blbk5ld0NoYXJhY3Rlck1vZGFsKCkge1xyXG4gICAgICAgIG5ldyBOZXdDaGFyYWN0ZXJNb2RhbCh0aGlzLmFwcCwgdGhpcy5wbHVnaW4sIHRoaXMuZm9sZGVyUGF0aCkub3BlbigpO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBOZXdDaGFyYWN0ZXJNb2RhbCBleHRlbmRzIE1vZGFsIHtcclxuICAgIHByaXZhdGUgY2hhcmFjdGVySW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsID0gbnVsbDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcHJpdmF0ZSBwbHVnaW46IFNjcmlwdFdyaXRpbmdQbHVnaW4sIHByaXZhdGUgZm9sZGVyUGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwKTtcclxuICAgIH1cclxuXHJcbiAgICBvbk9wZW4oKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgnaDInLCB7IHRleHQ6ICdDUkVBVEUgTkVXIENIQVJBQ1RFUicgfSk7XHJcbiAgICAgICAgdGhpcy5jaGFyYWN0ZXJJbnB1dCA9IGNvbnRlbnRFbC5jcmVhdGVFbCgnaW5wdXQnLCB7IHR5cGU6ICd0ZXh0JywgcGxhY2Vob2xkZXI6ICdFbnRlciBjaGFyYWN0ZXIgbmFtZS4uLicgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZUJ1dHRvbiA9IGNvbnRlbnRFbC5jcmVhdGVFbCgnYnV0dG9uJywgeyB0ZXh0OiAnQ3JlYXRlIENoYXJhY3RlcicgfSk7XHJcbiAgICAgICAgY3JlYXRlQnV0dG9uLm9uY2xpY2sgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNoYXJhY3RlcklucHV0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJOYW1lID0gdGhpcy5jaGFyYWN0ZXJJbnB1dC52YWx1ZS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hhcmFjdGVyTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLmNoYXJhY3Rlck1hbmFnZXIuY3JlYXRlTmV3Q2hhcmFjdGVyKGNoYXJhY3Rlck5hbWUsIHRoaXMuZm9sZGVyUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYENoYXJhY3RlciAke2NoYXJhY3Rlck5hbWV9IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsb3NlKCkge1xyXG4gICAgICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xyXG4gICAgICAgIGNvbnRlbnRFbC5lbXB0eSgpO1xyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=