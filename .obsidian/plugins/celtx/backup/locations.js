import { __awaiter } from "tslib";
import { Plugin, Modal, Notice, PluginSettingTab, Setting } from 'obsidian';
import path from 'path';
const DEFAULT_SETTINGS = {
    defaultLocationFolder: 'Lokace',
    autoCreateLocationFolder: true,
    hotkey: 'Mod+1', // Výchozí hodnota pro hotkey
};
export default class CeltxLikePlugin extends Plugin {
    constructor() {
        super(...arguments);
        this.settings = DEFAULT_SETTINGS;
    }
    onload() {
        return __awaiter(this, void 0, void 0, function* () {
            console.log("CeltxLikePlugin loaded");
            // Načtení nastavení
            yield this.loadSettings();
            // Přidání příkazů a nastavení UI
            this.addCommands();
            this.addSettingTab(new CeltxLikePluginSettingsTab(this.app, this));
        });
    }
    onunload() {
        console.log("CeltxLikePlugin unloaded");
    }
    loadSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            this.settings = Object.assign({}, DEFAULT_SETTINGS, yield this.loadData());
        });
    }
    saveSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.saveData(this.settings);
        });
    }
    addCommands() {
        this.addCommand({
            id: "open-location-list",
            name: "Open Location List",
            editorCallback: (editor) => {
                new LocationListModal(this.app, editor, this).open();
            },
            hotkeys: [{ modifiers: ["Mod"], key: this.settings.hotkey.split('+')[1] }], // Použití nastavené klávesové zkratky
        });
    }
    getLocationFiles(folderPath) {
        return __awaiter(this, void 0, void 0, function* () {
            const locationFolder = this.settings.defaultLocationFolder;
            console.log(`Using default location folder: ${locationFolder}`);
            return this.app.vault.getFiles().filter((file) => file.path.startsWith(folderPath));
        });
    }
    createNewLocation(location, type, folderPath) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.settings.autoCreateLocationFolder) {
                const locationFolderPath = path.join(folderPath, this.settings.defaultLocationFolder);
                try {
                    const folderExists = yield this.app.vault.adapter.exists(locationFolderPath);
                    if (!folderExists) {
                        yield this.app.vault.createFolder(locationFolderPath);
                        console.log(`Folder created at: ${locationFolderPath}`);
                    }
                }
                catch (error) {
                    console.error("Error creating folder:", error);
                    throw error;
                }
            }
            const locationFileName = `${type}-${location}-${path.basename(folderPath)}`;
            const locationFilePath = path.join(folderPath, this.settings.defaultLocationFolder, `${locationFileName}.md`);
            const file = yield this.app.vault.create(locationFilePath, '# ' + locationFileName);
            return file;
        });
    }
}
class CeltxLikePluginSettingsTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }
    display() {
        const { containerEl } = this;
        containerEl.empty();
        containerEl.createEl('h2', { text: 'CeltxLike Plugin Settings' });
        new Setting(containerEl)
            .setName('Default Location Folder')
            .setDesc('Folder name for storing locations')
            .addText((text) => text
            .setPlaceholder('Enter folder name')
            .setValue(this.plugin.settings.defaultLocationFolder)
            .onChange((value) => __awaiter(this, void 0, void 0, function* () {
            this.plugin.settings.defaultLocationFolder = value;
            yield this.plugin.saveSettings();
        })));
        new Setting(containerEl)
            .setName('Auto-create Location Folder')
            .setDesc('Automatically create location folder if not found')
            .addToggle((toggle) => toggle
            .setValue(this.plugin.settings.autoCreateLocationFolder)
            .onChange((value) => __awaiter(this, void 0, void 0, function* () {
            this.plugin.settings.autoCreateLocationFolder = value;
            yield this.plugin.saveSettings();
        })));
        new Setting(containerEl)
            .setName('Hotkey')
            .setDesc('Set the hotkey for opening the location list.')
            .addText((text) => text
            .setValue(this.plugin.settings.hotkey)
            .onChange((value) => __awaiter(this, void 0, void 0, function* () {
            this.plugin.settings.hotkey = value;
            yield this.plugin.saveSettings();
        })));
    }
}
class LocationListModal extends Modal {
    constructor(app, editor, pluginInstance) {
        super(app);
        this.locationNames = [];
        this.folderPath = '';
        this.editor = editor;
        this.pluginInstance = pluginInstance;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: 'SELECT OR CREATE LOCATION' });
        const newLocationButton = contentEl.createEl('button', { text: '+ ADD NEW LOCATION' });
        newLocationButton.onclick = () => this.openNewLocationModal();
        const locationListContainer = document.createElement('div');
        locationListContainer.style.display = 'flex';
        locationListContainer.style.flexDirection = 'column';
        locationListContainer.style.marginTop = '10px';
        contentEl.appendChild(locationListContainer);
        this.loadLocations(locationListContainer);
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
    loadLocations(locationListContainer) {
        return __awaiter(this, void 0, void 0, function* () {
            const activeFile = this.app.workspace.getActiveFile();
            if (!activeFile) {
                new Notice("NO FILE FOUND FOR THE CURRENT EDITOR.");
                return;
            }
            const filePath = activeFile.path;
            this.folderPath = path.dirname(filePath);
            let locationFiles = yield this.pluginInstance.getLocationFiles(this.folderPath);
            // Filtrování otevřeného souboru, aby se nezobrazoval v seznamu
            locationFiles = locationFiles.filter((file) => file.path !== filePath);
            // Pokud jsou k dispozici lokace, zobrazíme je
            if (locationFiles.length > 0) {
                this.locationNames = locationFiles.map((file) => path.basename(file.path, '.md'));
                this.locationNames.forEach(location => {
                    const locationItem = document.createElement('button');
                    locationItem.textContent = location;
                    locationItem.onclick = () => __awaiter(this, void 0, void 0, function* () {
                        yield this.openDayNightModal(location);
                    });
                    locationListContainer.appendChild(locationItem);
                });
            }
            else {
                const noLocationsMessage = document.createElement('p');
                noLocationsMessage.textContent = 'NO LOCATIONS AVAILABLE. CREATE ONE!';
                locationListContainer.appendChild(noLocationsMessage);
            }
        });
    }
    openDayNightModal(location) {
        return __awaiter(this, void 0, void 0, function* () {
            const dayNightModal = new DayNightModal(this.app, location, (dayNight) => {
                this.insertLocationText(location, dayNight);
            });
            dayNightModal.open();
        });
    }
    insertLocationText(location, dayNight) {
        return __awaiter(this, void 0, void 0, function* () {
            const [type, locationNameAndDay] = location.split('-');
            const [locationName] = locationNameAndDay.split('-');
            const fileName = `${type.toUpperCase()}-${locationName.toUpperCase()}-${path.basename(this.folderPath)}`;
            const formattedLocationText = `# ${type.toUpperCase()}. [[${fileName}|${locationName.toUpperCase()}]] - ${dayNight.toUpperCase()}`;
            const text = `${formattedLocationText}\n`;
            this.editor.replaceRange(text, this.editor.getCursor());
        });
    }
    openNewLocationModal() {
        return __awaiter(this, void 0, void 0, function* () {
            const newLocationModal = new NewLocationModal(this.app, this.pluginInstance, this.folderPath);
            newLocationModal.open();
        });
    }
}
class DayNightModal extends Modal {
    constructor(app, location, callback) {
        super(app);
        this.location = location;
        this.callback = callback;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: `SELECT TIME FOR LOCATION: ${this.location}` });
        const dayButton = contentEl.createEl('button', { text: 'DAY' });
        dayButton.onclick = () => this.selectDayNight('DAY');
        const nightButton = contentEl.createEl('button', { text: 'NIGHT' });
        nightButton.onclick = () => this.selectDayNight('NIGHT');
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
    selectDayNight(dayNight) {
        this.callback(dayNight); // CALLBACK TO INSERT TEXT INTO THE EDITOR
        this.close();
    }
}
class NewLocationModal extends Modal {
    constructor(app, pluginInstance, folderPath) {
        super(app);
        this.pluginInstance = pluginInstance;
        this.folderPath = folderPath;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: 'CREATE NEW LOCATION' });
        const typeSelect = contentEl.createEl('select');
        const optionInt = typeSelect.createEl('option', { text: 'INT' });
        const optionExt = typeSelect.createEl('option', { text: 'EXT' });
        const locationNameInput = contentEl.createEl('input');
        locationNameInput.placeholder = 'Enter location name';
        const createButton = contentEl.createEl('button', { text: 'CREATE' });
        createButton.onclick = () => __awaiter(this, void 0, void 0, function* () {
            const type = typeSelect.value;
            const locationName = locationNameInput.value.toUpperCase();
            yield this.createLocationFile(type, locationName);
        });
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
    createLocationFile(type, locationName) {
        return __awaiter(this, void 0, void 0, function* () {
            const locationFileName = `${type}-${locationName}-${path.basename(this.folderPath)}`;
            const locationFolderPath = path.join(this.folderPath, 'Lokace');
            try {
                const folderExists = yield this.app.vault.adapter.exists(locationFolderPath);
                if (!folderExists) {
                    yield this.app.vault.createFolder(locationFolderPath);
                }
            }
            catch (error) {
                console.error("Error creating folder:", error);
            }
            const locationFilePath = path.join(locationFolderPath, `${locationFileName}.md`);
            yield this.app.vault.create(locationFilePath, '# ' + locationFileName);
            new Notice(`LOCATION CREATED: ${locationFileName}`);
            this.close();
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vb2JzaWRpYW4gcGx1Z2luL2NlbHR4L2JhY2t1cC9sb2NhdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBcUMsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRS9HLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQVN4QixNQUFNLGdCQUFnQixHQUE0QjtJQUM5QyxxQkFBcUIsRUFBRSxRQUFRO0lBQy9CLHdCQUF3QixFQUFFLElBQUk7SUFDOUIsTUFBTSxFQUFFLE9BQU8sRUFBRSw2QkFBNkI7Q0FDakQsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sZUFBZ0IsU0FBUSxNQUFNO0lBQW5EOztRQUNJLGFBQVEsR0FBNEIsZ0JBQWdCLENBQUM7SUErRHpELENBQUM7SUE3RFMsTUFBTTs7WUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFFdEMsb0JBQW9CO1lBQ3BCLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRTFCLGlDQUFpQztZQUNqQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLDBCQUEwQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN2RSxDQUFDO0tBQUE7SUFFRCxRQUFRO1FBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFYSxZQUFZOztZQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDL0UsQ0FBQztL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QUUsWUFBb0I7O1lBQy9ELE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxJQUFJLElBQUksWUFBWSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFDckYsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFaEUsSUFBSSxDQUFDO2dCQUNELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUM3RSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7b0JBQ2hCLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLENBQUM7Z0JBQzFELENBQUM7WUFDTCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25ELENBQUM7WUFFRCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxnQkFBZ0IsS0FBSyxDQUFDLENBQUM7WUFDakYsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxHQUFHLGdCQUFnQixDQUFDLENBQUM7WUFDdkUsSUFBSSxNQUFNLENBQUMscUJBQXFCLGdCQUFnQixFQUFFLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDakIsQ0FBQztLQUFBO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbHVnaW4sIE1vZGFsLCBOb3RpY2UsIEVkaXRvciwgVEZpbGUsIEFwcCBhcyBPYnNpZGlhbkFwcCwgUGx1Z2luU2V0dGluZ1RhYiwgU2V0dGluZyB9IGZyb20gJ29ic2lkaWFuJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcblxyXG4vLyBOYXN0YXZlbsOtIHBsdWdpbnVcclxuaW50ZXJmYWNlIENlbHR4TGlrZVBsdWdpblNldHRpbmdzIHtcclxuICAgIGRlZmF1bHRMb2NhdGlvbkZvbGRlcjogc3RyaW5nO1xyXG4gICAgYXV0b0NyZWF0ZUxvY2F0aW9uRm9sZGVyOiBib29sZWFuO1xyXG4gICAgaG90a2V5OiBzdHJpbmc7IC8vIFDFmWlkw6Fuw60gbW/Fvm5vc3RpIHBybyBob3RrZXlcclxufVxyXG5cclxuY29uc3QgREVGQVVMVF9TRVRUSU5HUzogQ2VsdHhMaWtlUGx1Z2luU2V0dGluZ3MgPSB7XHJcbiAgICBkZWZhdWx0TG9jYXRpb25Gb2xkZXI6ICdMb2thY2UnLFxyXG4gICAgYXV0b0NyZWF0ZUxvY2F0aW9uRm9sZGVyOiB0cnVlLFxyXG4gICAgaG90a2V5OiAnTW9kKzEnLCAvLyBWw71jaG96w60gaG9kbm90YSBwcm8gaG90a2V5XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDZWx0eExpa2VQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xyXG4gICAgc2V0dGluZ3M6IENlbHR4TGlrZVBsdWdpblNldHRpbmdzID0gREVGQVVMVF9TRVRUSU5HUztcclxuXHJcbiAgICBhc3luYyBvbmxvYWQoKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJDZWx0eExpa2VQbHVnaW4gbG9hZGVkXCIpO1xyXG5cclxuICAgICAgICAvLyBOYcSNdGVuw60gbmFzdGF2ZW7DrVxyXG4gICAgICAgIGF3YWl0IHRoaXMubG9hZFNldHRpbmdzKCk7XHJcblxyXG4gICAgICAgIC8vIFDFmWlkw6Fuw60gcMWZw61rYXrFryBhIG5hc3RhdmVuw60gVUlcclxuICAgICAgICB0aGlzLmFkZENvbW1hbmRzKCk7XHJcbiAgICAgICAgdGhpcy5hZGRTZXR0aW5nVGFiKG5ldyBDZWx0eExpa2VQbHVnaW5TZXR0aW5nc1RhYih0aGlzLmFwcCwgdGhpcykpO1xyXG4gICAgfVxyXG5cclxuICAgIG9udW5sb2FkKCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ2VsdHhMaWtlUGx1Z2luIHVubG9hZGVkXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgbG9hZFNldHRpbmdzKCkge1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX1NFVFRJTkdTLCBhd2FpdCB0aGlzLmxvYWREYXRhKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBzYXZlU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5zYXZlRGF0YSh0aGlzLnNldHRpbmdzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFkZENvbW1hbmRzKCkge1xyXG4gICAgICAgIHRoaXMuYWRkQ29tbWFuZCh7XHJcbiAgICAgICAgICAgIGlkOiBcIm9wZW4tbG9jYXRpb24tbGlzdFwiLFxyXG4gICAgICAgICAgICBuYW1lOiBcIk9wZW4gTG9jYXRpb24gTGlzdFwiLFxyXG4gICAgICAgICAgICBlZGl0b3JDYWxsYmFjazogKGVkaXRvcjogRWRpdG9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBuZXcgTG9jYXRpb25MaXN0TW9kYWwodGhpcy5hcHAsIGVkaXRvciwgdGhpcykub3BlbigpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBob3RrZXlzOiBbeyBtb2RpZmllcnM6IFtcIk1vZFwiXSwga2V5OiB0aGlzLnNldHRpbmdzLmhvdGtleS5zcGxpdCgnKycpWzFdIH1dLCAvLyBQb3XFvml0w60gbmFzdGF2ZW7DqSBrbMOhdmVzb3bDqSB6a3JhdGt5XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGdldExvY2F0aW9uRmlsZXMoZm9sZGVyUGF0aDogc3RyaW5nKTogUHJvbWlzZTxURmlsZVtdPiB7XHJcbiAgICAgICAgY29uc3QgbG9jYXRpb25Gb2xkZXIgPSB0aGlzLnNldHRpbmdzLmRlZmF1bHRMb2NhdGlvbkZvbGRlcjtcclxuICAgICAgICBjb25zb2xlLmxvZyhgVXNpbmcgZGVmYXVsdCBsb2NhdGlvbiBmb2xkZXI6ICR7bG9jYXRpb25Gb2xkZXJ9YCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwLnZhdWx0LmdldEZpbGVzKCkuZmlsdGVyKChmaWxlOiBURmlsZSkgPT4gZmlsZS5wYXRoLnN0YXJ0c1dpdGgoZm9sZGVyUGF0aCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVOZXdMb2NhdGlvbihsb2NhdGlvbjogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGZvbGRlclBhdGg6IHN0cmluZyk6IFByb21pc2U8VEZpbGU+IHtcclxuICAgICAgICBpZiAodGhpcy5zZXR0aW5ncy5hdXRvQ3JlYXRlTG9jYXRpb25Gb2xkZXIpIHtcclxuICAgICAgICAgICAgY29uc3QgbG9jYXRpb25Gb2xkZXJQYXRoID0gcGF0aC5qb2luKGZvbGRlclBhdGgsIHRoaXMuc2V0dGluZ3MuZGVmYXVsdExvY2F0aW9uRm9sZGVyKTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvbGRlckV4aXN0cyA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmFkYXB0ZXIuZXhpc3RzKGxvY2F0aW9uRm9sZGVyUGF0aCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZvbGRlckV4aXN0cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZUZvbGRlcihsb2NhdGlvbkZvbGRlclBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBGb2xkZXIgY3JlYXRlZCBhdDogJHtsb2NhdGlvbkZvbGRlclBhdGh9YCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgY3JlYXRpbmcgZm9sZGVyOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbG9jYXRpb25GaWxlTmFtZSA9IGAke3R5cGV9LSR7bG9jYXRpb259LSR7cGF0aC5iYXNlbmFtZShmb2xkZXJQYXRoKX1gO1xyXG4gICAgICAgIGNvbnN0IGxvY2F0aW9uRmlsZVBhdGggPSBwYXRoLmpvaW4oZm9sZGVyUGF0aCwgdGhpcy5zZXR0aW5ncy5kZWZhdWx0TG9jYXRpb25Gb2xkZXIsIGAke2xvY2F0aW9uRmlsZU5hbWV9Lm1kYCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGUobG9jYXRpb25GaWxlUGF0aCwgJyMgJyArIGxvY2F0aW9uRmlsZU5hbWUpO1xyXG4gICAgICAgIHJldHVybiBmaWxlO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBDZWx0eExpa2VQbHVnaW5TZXR0aW5nc1RhYiBleHRlbmRzIFBsdWdpblNldHRpbmdUYWIge1xyXG4gICAgcGx1Z2luOiBDZWx0eExpa2VQbHVnaW47XHJcblxyXG4gICAgY29uc3RydWN0b3IoYXBwOiBPYnNpZGlhbkFwcCwgcGx1Z2luOiBDZWx0eExpa2VQbHVnaW4pIHtcclxuICAgICAgICBzdXBlcihhcHAsIHBsdWdpbik7XHJcbiAgICAgICAgdGhpcy5wbHVnaW4gPSBwbHVnaW47XHJcbiAgICB9XHJcblxyXG4gICAgZGlzcGxheSgpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB7IGNvbnRhaW5lckVsIH0gPSB0aGlzO1xyXG5cclxuICAgICAgICBjb250YWluZXJFbC5lbXB0eSgpO1xyXG4gICAgICAgIGNvbnRhaW5lckVsLmNyZWF0ZUVsKCdoMicsIHsgdGV4dDogJ0NlbHR4TGlrZSBQbHVnaW4gU2V0dGluZ3MnIH0pO1xyXG5cclxuICAgICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcclxuICAgICAgICAgICAgLnNldE5hbWUoJ0RlZmF1bHQgTG9jYXRpb24gRm9sZGVyJylcclxuICAgICAgICAgICAgLnNldERlc2MoJ0ZvbGRlciBuYW1lIGZvciBzdG9yaW5nIGxvY2F0aW9ucycpXHJcbiAgICAgICAgICAgIC5hZGRUZXh0KCh0ZXh0OiBhbnkpID0+IHRleHRcclxuICAgICAgICAgICAgICAgIC5zZXRQbGFjZWhvbGRlcignRW50ZXIgZm9sZGVyIG5hbWUnKVxyXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLmRlZmF1bHRMb2NhdGlvbkZvbGRlcilcclxuICAgICAgICAgICAgICAgIC5vbkNoYW5nZShhc3luYyAodmFsdWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLmRlZmF1bHRMb2NhdGlvbkZvbGRlciA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcclxuICAgICAgICAgICAgLnNldE5hbWUoJ0F1dG8tY3JlYXRlIExvY2F0aW9uIEZvbGRlcicpXHJcbiAgICAgICAgICAgIC5zZXREZXNjKCdBdXRvbWF0aWNhbGx5IGNyZWF0ZSBsb2NhdGlvbiBmb2xkZXIgaWYgbm90IGZvdW5kJylcclxuICAgICAgICAgICAgLmFkZFRvZ2dsZSgodG9nZ2xlOiBhbnkpID0+IHRvZ2dsZVxyXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLmF1dG9DcmVhdGVMb2NhdGlvbkZvbGRlcilcclxuICAgICAgICAgICAgICAgIC5vbkNoYW5nZShhc3luYyAodmFsdWU6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5zZXR0aW5ncy5hdXRvQ3JlYXRlTG9jYXRpb25Gb2xkZXIgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5zYXZlU2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXHJcbiAgICAgICAgICAgIC5zZXROYW1lKCdIb3RrZXknKVxyXG4gICAgICAgICAgICAuc2V0RGVzYygnU2V0IHRoZSBob3RrZXkgZm9yIG9wZW5pbmcgdGhlIGxvY2F0aW9uIGxpc3QuJylcclxuICAgICAgICAgICAgLmFkZFRleHQoKHRleHQ6IGFueSkgPT4gdGV4dFxyXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKHRoaXMucGx1Z2luLnNldHRpbmdzLmhvdGtleSlcclxuICAgICAgICAgICAgICAgIC5vbkNoYW5nZShhc3luYyAodmFsdWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLmhvdGtleSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBMb2NhdGlvbkxpc3RNb2RhbCBleHRlbmRzIE1vZGFsIHtcclxuICAgIHByaXZhdGUgZWRpdG9yOiBFZGl0b3I7XHJcbiAgICBwcml2YXRlIGxvY2F0aW9uTmFtZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBwcml2YXRlIGZvbGRlclBhdGg6IHN0cmluZyA9ICcnO1xyXG4gICAgcHJpdmF0ZSBwbHVnaW5JbnN0YW5jZTogQ2VsdHhMaWtlUGx1Z2luO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGFwcDogYW55LCBlZGl0b3I6IEVkaXRvciwgcGx1Z2luSW5zdGFuY2U6IENlbHR4TGlrZVBsdWdpbikge1xyXG4gICAgICAgIHN1cGVyKGFwcCk7XHJcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7XHJcbiAgICAgICAgdGhpcy5wbHVnaW5JbnN0YW5jZSA9IHBsdWdpbkluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIG9uT3BlbigpIHtcclxuICAgICAgICBjb25zdCB7IGNvbnRlbnRFbCB9ID0gdGhpcztcclxuICAgICAgICBjb250ZW50RWwuY3JlYXRlRWwoJ2gyJywgeyB0ZXh0OiAnU0VMRUNUIE9SIENSRUFURSBMT0NBVElPTicgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld0xvY2F0aW9uQnV0dG9uID0gY29udGVudEVsLmNyZWF0ZUVsKCdidXR0b24nLCB7IHRleHQ6ICcrIEFERCBORVcgTE9DQVRJT04nIH0pO1xyXG4gICAgICAgIG5ld0xvY2F0aW9uQnV0dG9uLm9uY2xpY2sgPSAoKSA9PiB0aGlzLm9wZW5OZXdMb2NhdGlvbk1vZGFsKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxvY2F0aW9uTGlzdENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIGxvY2F0aW9uTGlzdENvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xyXG4gICAgICAgIGxvY2F0aW9uTGlzdENvbnRhaW5lci5zdHlsZS5mbGV4RGlyZWN0aW9uID0gJ2NvbHVtbic7XHJcbiAgICAgICAgbG9jYXRpb25MaXN0Q29udGFpbmVyLnN0eWxlLm1hcmdpblRvcCA9ICcxMHB4JztcclxuICAgICAgICBjb250ZW50RWwuYXBwZW5kQ2hpbGQobG9jYXRpb25MaXN0Q29udGFpbmVyKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2FkTG9jYXRpb25zKGxvY2F0aW9uTGlzdENvbnRhaW5lcik7XHJcbiAgICB9XHJcblxyXG4gICAgb25DbG9zZSgpIHtcclxuICAgICAgICBjb25zdCB7IGNvbnRlbnRFbCB9ID0gdGhpcztcclxuICAgICAgICBjb250ZW50RWwuZW1wdHkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIGxvYWRMb2NhdGlvbnMobG9jYXRpb25MaXN0Q29udGFpbmVyOiBIVE1MRWxlbWVudCkge1xyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUZpbGUgPSB0aGlzLmFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlRmlsZSgpO1xyXG4gICAgICAgIGlmICghYWN0aXZlRmlsZSkge1xyXG4gICAgICAgICAgICBuZXcgTm90aWNlKFwiTk8gRklMRSBGT1VORCBGT1IgVEhFIENVUlJFTlQgRURJVE9SLlwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBhY3RpdmVGaWxlLnBhdGg7XHJcbiAgICAgICAgdGhpcy5mb2xkZXJQYXRoID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcclxuXHJcbiAgICAgICAgbGV0IGxvY2F0aW9uRmlsZXMgPSBhd2FpdCB0aGlzLnBsdWdpbkluc3RhbmNlLmdldExvY2F0aW9uRmlsZXModGhpcy5mb2xkZXJQYXRoKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBGaWx0cm92w6Fuw60gb3RldsWZZW7DqWhvIHNvdWJvcnUsIGFieSBzZSBuZXpvYnJhem92YWwgdiBzZXpuYW11XHJcbiAgICAgICAgbG9jYXRpb25GaWxlcyA9IGxvY2F0aW9uRmlsZXMuZmlsdGVyKChmaWxlOiBURmlsZSkgPT4gZmlsZS5wYXRoICE9PSBmaWxlUGF0aCk7XHJcblxyXG4gICAgICAgIC8vIFBva3VkIGpzb3UgayBkaXNwb3ppY2kgbG9rYWNlLCB6b2JyYXrDrW1lIGplXHJcbiAgICAgICAgaWYgKGxvY2F0aW9uRmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmxvY2F0aW9uTmFtZXMgPSBsb2NhdGlvbkZpbGVzLm1hcCgoZmlsZTogVEZpbGUpID0+IHBhdGguYmFzZW5hbWUoZmlsZS5wYXRoLCAnLm1kJykpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5sb2NhdGlvbk5hbWVzLmZvckVhY2gobG9jYXRpb24gPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb25JdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdGlvbkl0ZW0udGV4dENvbnRlbnQgPSBsb2NhdGlvbjtcclxuICAgICAgICAgICAgICAgIGxvY2F0aW9uSXRlbS5vbmNsaWNrID0gYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMub3BlbkRheU5pZ2h0TW9kYWwobG9jYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGxvY2F0aW9uTGlzdENvbnRhaW5lci5hcHBlbmRDaGlsZChsb2NhdGlvbkl0ZW0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBub0xvY2F0aW9uc01lc3NhZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgICAgICAgICAgIG5vTG9jYXRpb25zTWVzc2FnZS50ZXh0Q29udGVudCA9ICdOTyBMT0NBVElPTlMgQVZBSUxBQkxFLiBDUkVBVEUgT05FISc7XHJcbiAgICAgICAgICAgIGxvY2F0aW9uTGlzdENvbnRhaW5lci5hcHBlbmRDaGlsZChub0xvY2F0aW9uc01lc3NhZ2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIG9wZW5EYXlOaWdodE1vZGFsKGxvY2F0aW9uOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBkYXlOaWdodE1vZGFsID0gbmV3IERheU5pZ2h0TW9kYWwodGhpcy5hcHAsIGxvY2F0aW9uLCAoZGF5TmlnaHQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmluc2VydExvY2F0aW9uVGV4dChsb2NhdGlvbiwgZGF5TmlnaHQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGRheU5pZ2h0TW9kYWwub3BlbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgaW5zZXJ0TG9jYXRpb25UZXh0KGxvY2F0aW9uOiBzdHJpbmcsIGRheU5pZ2h0OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBbdHlwZSwgbG9jYXRpb25OYW1lQW5kRGF5XSA9IGxvY2F0aW9uLnNwbGl0KCctJyk7XHJcbiAgICAgICAgY29uc3QgW2xvY2F0aW9uTmFtZV0gPSBsb2NhdGlvbk5hbWVBbmREYXkuc3BsaXQoJy0nKTtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7dHlwZS50b1VwcGVyQ2FzZSgpfS0ke2xvY2F0aW9uTmFtZS50b1VwcGVyQ2FzZSgpfS0ke3BhdGguYmFzZW5hbWUodGhpcy5mb2xkZXJQYXRoKX1gO1xyXG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZExvY2F0aW9uVGV4dCA9IGAjICR7dHlwZS50b1VwcGVyQ2FzZSgpfS4gW1ske2ZpbGVOYW1lfXwke2xvY2F0aW9uTmFtZS50b1VwcGVyQ2FzZSgpfV1dIC0gJHtkYXlOaWdodC50b1VwcGVyQ2FzZSgpfWA7XHJcbiAgICBcclxuICAgICAgICBjb25zdCB0ZXh0ID0gYCR7Zm9ybWF0dGVkTG9jYXRpb25UZXh0fVxcbmA7XHJcbiAgICAgICAgdGhpcy5lZGl0b3IucmVwbGFjZVJhbmdlKHRleHQsIHRoaXMuZWRpdG9yLmdldEN1cnNvcigpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIG9wZW5OZXdMb2NhdGlvbk1vZGFsKCkge1xyXG4gICAgICAgIGNvbnN0IG5ld0xvY2F0aW9uTW9kYWwgPSBuZXcgTmV3TG9jYXRpb25Nb2RhbCh0aGlzLmFwcCwgdGhpcy5wbHVnaW5JbnN0YW5jZSwgdGhpcy5mb2xkZXJQYXRoKTtcclxuICAgICAgICBuZXdMb2NhdGlvbk1vZGFsLm9wZW4oKTtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgRGF5TmlnaHRNb2RhbCBleHRlbmRzIE1vZGFsIHtcclxuICAgIHByaXZhdGUgbG9jYXRpb246IHN0cmluZztcclxuICAgIHByaXZhdGUgY2FsbGJhY2s6IChkYXlOaWdodDogc3RyaW5nKSA9PiB2b2lkO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGFwcDogYW55LCBsb2NhdGlvbjogc3RyaW5nLCBjYWxsYmFjazogKGRheU5pZ2h0OiBzdHJpbmcpID0+IHZvaWQpIHtcclxuICAgICAgICBzdXBlcihhcHApO1xyXG4gICAgICAgIHRoaXMubG9jYXRpb24gPSBsb2NhdGlvbjtcclxuICAgICAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7XHJcbiAgICB9XHJcblxyXG4gICAgb25PcGVuKCkge1xyXG4gICAgICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xyXG4gICAgICAgIGNvbnRlbnRFbC5jcmVhdGVFbCgnaDInLCB7IHRleHQ6IGBTRUxFQ1QgVElNRSBGT1IgTE9DQVRJT046ICR7dGhpcy5sb2NhdGlvbn1gIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBkYXlCdXR0b24gPSBjb250ZW50RWwuY3JlYXRlRWwoJ2J1dHRvbicsIHsgdGV4dDogJ0RBWScgfSk7XHJcbiAgICAgICAgZGF5QnV0dG9uLm9uY2xpY2sgPSAoKSA9PiB0aGlzLnNlbGVjdERheU5pZ2h0KCdEQVknKTtcclxuXHJcbiAgICAgICAgY29uc3QgbmlnaHRCdXR0b24gPSBjb250ZW50RWwuY3JlYXRlRWwoJ2J1dHRvbicsIHsgdGV4dDogJ05JR0hUJyB9KTtcclxuICAgICAgICBuaWdodEJ1dHRvbi5vbmNsaWNrID0gKCkgPT4gdGhpcy5zZWxlY3REYXlOaWdodCgnTklHSFQnKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsb3NlKCkge1xyXG4gICAgICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xyXG4gICAgICAgIGNvbnRlbnRFbC5lbXB0eSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0RGF5TmlnaHQoZGF5TmlnaHQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuY2FsbGJhY2soZGF5TmlnaHQpOyAvLyBDQUxMQkFDSyBUTyBJTlNFUlQgVEVYVCBJTlRPIFRIRSBFRElUT1JcclxuICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIE5ld0xvY2F0aW9uTW9kYWwgZXh0ZW5kcyBNb2RhbCB7XHJcbiAgICBwcml2YXRlIHBsdWdpbkluc3RhbmNlOiBDZWx0eExpa2VQbHVnaW47XHJcbiAgICBwcml2YXRlIGZvbGRlclBhdGg6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihhcHA6IGFueSwgcGx1Z2luSW5zdGFuY2U6IENlbHR4TGlrZVBsdWdpbiwgZm9sZGVyUGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgc3VwZXIoYXBwKTtcclxuICAgICAgICB0aGlzLnBsdWdpbkluc3RhbmNlID0gcGx1Z2luSW5zdGFuY2U7XHJcbiAgICAgICAgdGhpcy5mb2xkZXJQYXRoID0gZm9sZGVyUGF0aDtcclxuICAgIH1cclxuXHJcbiAgICBvbk9wZW4oKSB7XHJcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XHJcbiAgICAgICAgY29udGVudEVsLmNyZWF0ZUVsKCdoMicsIHsgdGV4dDogJ0NSRUFURSBORVcgTE9DQVRJT04nIH0pO1xyXG5cclxuICAgICAgICBjb25zdCB0eXBlU2VsZWN0ID0gY29udGVudEVsLmNyZWF0ZUVsKCdzZWxlY3QnKTtcclxuICAgICAgICBjb25zdCBvcHRpb25JbnQgPSB0eXBlU2VsZWN0LmNyZWF0ZUVsKCdvcHRpb24nLCB7IHRleHQ6ICdJTlQnIH0pO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbkV4dCA9IHR5cGVTZWxlY3QuY3JlYXRlRWwoJ29wdGlvbicsIHsgdGV4dDogJ0VYVCcgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxvY2F0aW9uTmFtZUlucHV0ID0gY29udGVudEVsLmNyZWF0ZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIGxvY2F0aW9uTmFtZUlucHV0LnBsYWNlaG9sZGVyID0gJ0VudGVyIGxvY2F0aW9uIG5hbWUnO1xyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVCdXR0b24gPSBjb250ZW50RWwuY3JlYXRlRWwoJ2J1dHRvbicsIHsgdGV4dDogJ0NSRUFURScgfSk7XHJcbiAgICAgICAgY3JlYXRlQnV0dG9uLm9uY2xpY2sgPSBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlU2VsZWN0LnZhbHVlO1xyXG4gICAgICAgICAgICBjb25zdCBsb2NhdGlvbk5hbWUgPSBsb2NhdGlvbk5hbWVJbnB1dC52YWx1ZS50b1VwcGVyQ2FzZSgpO1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNyZWF0ZUxvY2F0aW9uRmlsZSh0eXBlLCBsb2NhdGlvbk5hbWUpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgb25DbG9zZSgpIHtcclxuICAgICAgICBjb25zdCB7IGNvbnRlbnRFbCB9ID0gdGhpcztcclxuICAgICAgICBjb250ZW50RWwuZW1wdHkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZUxvY2F0aW9uRmlsZSh0eXBlOiBzdHJpbmcsIGxvY2F0aW9uTmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgbG9jYXRpb25GaWxlTmFtZSA9IGAke3R5cGV9LSR7bG9jYXRpb25OYW1lfS0ke3BhdGguYmFzZW5hbWUodGhpcy5mb2xkZXJQYXRoKX1gO1xyXG4gICAgICAgIGNvbnN0IGxvY2F0aW9uRm9sZGVyUGF0aCA9IHBhdGguam9pbih0aGlzLmZvbGRlclBhdGgsICdMb2thY2UnKTtcclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBmb2xkZXJFeGlzdHMgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5hZGFwdGVyLmV4aXN0cyhsb2NhdGlvbkZvbGRlclBhdGgpO1xyXG4gICAgICAgICAgICBpZiAoIWZvbGRlckV4aXN0cykge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuY3JlYXRlRm9sZGVyKGxvY2F0aW9uRm9sZGVyUGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgY3JlYXRpbmcgZm9sZGVyOlwiLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBsb2NhdGlvbkZpbGVQYXRoID0gcGF0aC5qb2luKGxvY2F0aW9uRm9sZGVyUGF0aCwgYCR7bG9jYXRpb25GaWxlTmFtZX0ubWRgKTtcclxuICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGUobG9jYXRpb25GaWxlUGF0aCwgJyMgJyArIGxvY2F0aW9uRmlsZU5hbWUpO1xyXG4gICAgICAgIG5ldyBOb3RpY2UoYExPQ0FUSU9OIENSRUFURUQ6ICR7bG9jYXRpb25GaWxlTmFtZX1gKTtcclxuICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICB9XHJcbn1cclxuIl19